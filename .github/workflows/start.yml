name: Fabric Server - é›²ç«¯ä¸–ç•Œå‚™ä»½ (ZeroTier VPN)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [fabric-server-cloud-backup-zerotier-vpn]

jobs:
  minecraft:
    runs-on: ubuntu-22.04

    env:
      RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
      RCON_PORT: ${{ secrets.RCON_PORT }}
      API_TOKEN: ${{ secrets.API_TOKEN }}

    steps:
      - name: æª¢å‡º repo æª”æ¡ˆ
        uses: actions/checkout@v4

      - name: æ›¿æ› server.properties ä¸­çš„ RCON è¨­å®š
        run: |
          sed -i "s|rcon.password=.*|rcon.password=${RCON_PASSWORD}|" server.properties
          sed -i "s|rcon.port=.*|rcon.port=${RCON_PORT}|" server.properties


      - name: å®‰è£ Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: å®‰è£ Python å’Œ gdown
        run: |
          sudo apt update
          sudo apt install python3-pip unzip
          pip install gdown

      - name: å®‰è£ screen
        run: sudo apt-get install -y screen

      - name: å®‰è£ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: åˆå§‹åŒ– Node.js ä¸¦å®‰è£ Express
        run: |
          cd minecraft-log-stream
          npm init -y
          npm install express

      - name: å®‰è£ rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: å¯«å…¥ rclone è¨­å®šæª”ï¼ˆbase64ï¼‰
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: ä¸‹è¼‰åˆ†å·ä¸¦åˆä½µè§£å£“
        run: |
          echo "æ­£åœ¨å¾ç¬¬äºŒå€‹å¸³è™Ÿä¸‹è¼‰æ‰€æœ‰ä¸–ç•Œåˆ†å·..."
          # 1. ä¸‹è¼‰ CobblemonWorld è³‡æ–™å¤¾ä¸‹æ‰€æœ‰ä»¥ world é–‹é ­çš„æª”æ¡ˆ
          rclone -vv copy gdrive2:CobblemonWorld/ . \
            --include "world.z*" \
            --include "world.zip" \
            --drive-chunk-size 256M \
            --tpslimit 3 \
            --stats 10s

          echo "æ­£åœ¨æª¢æŸ¥ä¸‹è¼‰çš„æª”æ¡ˆ..."
          ls -lh world.*

          # 2. åˆä½µåˆ†å· (é€™æ˜¯é—œéµ)
          # -s 0 ä»£è¡¨å°‡åˆ†å‰²å·åˆä½µæˆä¸€å€‹å®Œæ•´çš„å–®ä¸€ zip
          # world.zip æ˜¯ä¸»ç´¢å¼•æª”ï¼Œ--out æŒ‡å®šè¼¸å‡ºçš„å®Œæ•´æª”å
          echo "æ­£åœ¨åˆä½µåˆ†å·..."
          zip -v -s 0 world.zip --out combined_world.zip

          echo "2. é—œéµå‹•ä½œï¼šç«‹å³åˆªé™¤æ‰€æœ‰åˆ†å‰²å·ï¼Œé˜²æ­¢å¹²æ“¾è§£å£“..."
          # é€™è£¡æŠŠ world.z01, world.z02, world.zip å…¨éƒ¨ç æ‰
          # é¨°å‡º 5.5GB ç©ºé–“ï¼Œä¸¦è®“ unzip åªèƒ½çœ‹åˆ°å”¯ä¸€ä¸€å€‹æª”æ¡ˆ
          rm -f world.z01 world.z02 world.zip

          # 3. åŸ·è¡Œè§£å£“ (ä¸é¡¯ç¤ºè©³ç´°æ—¥èªŒï¼Œæ¸›å°‘è¼¸å‡ºè² æ“”ï¼Œç¯€çœ Runner è³‡æº)
          echo "æ­£åœ¨è§£å£“ä¸–ç•Œå­˜æª” (è«‹ç¨å€™)..."
          unzip -q -o combined_world.zip

          # 4. ã€é—œéµã€‘è§£å£“å®Œç«‹åˆ»åˆªé™¤åˆä½µæª”
          echo "æ­£åœ¨åˆªé™¤åˆä½µæª”ï¼Œé‡‹æ”¾æœ€å¾Œçš„ç©ºé–“..."
          rm -f combined_world.zip

          # 5. æª¢æŸ¥çµæœ
          echo "æª¢æŸ¥ world è³‡æ–™å¤¾æ˜¯å¦å°±ç·’ï¼š"
          if [ -d "world" ]; then
            echo "æˆåŠŸï¼world è³‡æ–™å¤¾å·²å‡ºç¾ã€‚"
            ls -d world/
          else
            echo "ä¾èˆŠæ‰¾ä¸åˆ°è³‡æ–™å¤¾ï¼Œé¡¯ç¤ºç•¶å‰æ‰€æœ‰æª”æ¡ˆï¼š"
            ls -lh
            exit 1
          fi

      
      - name: ä¸‹è¼‰ Cobblemon-fabric-1.7.1+1.21.1.jarï¼ˆå¾ Google Driveï¼‰
        env:
          FILE_ID: ${{ secrets.GDRIVE_FILE_ID2 }}
        run: |
          echo "å¾ Google Drive ä¸‹è¼‰ Cobblemon-fabric-1.7.1+1.21.1.jar..."
          gdown --id $FILE_ID -O "mods/Cobblemon-fabric-1.7.1+1.21.1.jar"

      - name: å®‰è£ ZeroTier CLI
        run: |
          for i in {1..5}; do
            echo "Attempt $i to install ZeroTier"
            curl -f -s https://install.zerotier.com -o install.sh && break
            echo "Retrying in 5 seconds..."
            sleep 5
          done

          if [ ! -f install.sh ]; then
            echo "âŒ Failed to download install script from install.zerotier.com"
            exit 1
          fi

          chmod +x install.sh
          sudo ./install.sh

      - name: åŒ¯å…¥ ZeroTier èº«ä»½æª”æ¡ˆï¼ˆä¿è­‰å›ºå®š IPï¼‰
        run: |
          sudo systemctl stop zerotier-one

          echo "${{ secrets.ZT_IDENTITY_SECRET }}" | sudo tee /var/lib/zerotier-one/identity.secret > /dev/null
          sudo chmod 600 /var/lib/zerotier-one/identity.secret

          sudo systemctl start zerotier-one

          echo "ç­‰å¾… identity.public ç”Ÿæˆ..."
          for i in {1..10}; do
            if [ -f /var/lib/zerotier-one/identity.public ]; then
              echo "âœ… identity.public å·²ç”Ÿæˆ"
              break
            fi
            echo "â³ identity.public å°šæœªå‡ºç¾ï¼Œç­‰å¾… 1 ç§’..."
            sleep 1
          done

          echo "ç›®å‰èº«ä»½ï¼š"
          sudo cat /var/lib/zerotier-one/identity.public || echo "âš ï¸ ç„¡æ³•è®€å–èº«ä»½"

      - name: åŠ å…¥ ZeroTier ç¶²è·¯
        env:
          ZT_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
        run: |
          echo "âœ… æª¢æŸ¥ ZeroTier æœå‹™æ˜¯å¦å•Ÿå‹•..."
          for i in {1..10}; do
            if sudo zerotier-cli info &>/dev/null; then
              echo "âœ… ZeroTier æœå‹™å·²å•Ÿå‹•"
              break
            fi
            echo "â³ ç­‰å¾… ZeroTier æœå‹™å•Ÿå‹•... ($i/10)"
            sleep 2
          done

          echo "ğŸš€ å˜—è©¦åŠ å…¥ ZeroTier ç¶²è·¯ï¼š$ZT_NETWORK_ID"
          sudo zerotier-cli join $ZT_NETWORK_ID || {
            echo "âŒ åŠ å…¥ ZeroTier ç¶²è·¯å¤±æ•—"
            exit 1
          }

          echo "ğŸ•“ ç­‰å¾… ZeroTier æˆåŠŸé€£ç·š..."
          for i in {1..20}; do
            STATUS=$(sudo zerotier-cli listnetworks | grep $ZT_NETWORK_ID | awk '{print $5}')
            echo "ç›®å‰ç‹€æ…‹ï¼š$STATUS"
            if [[ "$STATUS" == "OK" ]]; then
              echo "âœ… å·²æˆåŠŸåŠ å…¥ ZeroTier ç¶²è·¯"
              break
            fi
            sleep 3
          done

      - name: æ¸¬è©¦
        run: sudo ss -nuap | grep 9993

      - name: é¡¯ç¤º ZeroTier IP
        run: sudo zerotier-cli listnetworks

      - name: é¡¯ç¤º ZeroTier èº«ä»½æª”æ¡ˆï¼ˆåªç”¨ä¸€æ¬¡ï¼‰
        run: |
          echo "========== BEGIN identity.secret =========="
          sudo cat /var/lib/zerotier-one/identity.secret
          echo "=========== END identity.secret ==========="

      - name: å•Ÿå‹• Fabric Serverï¼ˆä½¿ç”¨ screenï¼‰
        run: |
          screen -L -dmS minecraft java -Xmx6G -Xms6G -jar fabric-server-launch.jar nogui

          # å•Ÿå‹• API æœå‹™
          cd minecraft-log-stream
          nohup node api.js > api.log 2>&1 &

          # ç­‰å¾… API å¥åº·æª¢æŸ¥æˆåŠŸ
          for i in {1..30}; do
            if curl --silent --fail http://localhost:3000/health >/dev/null; then
              echo "API is up!"
              break
            else
              echo "Waiting for API..."
              sleep 1
            fi
          done

      - name: å•Ÿå‹• Log Viewer Server
        run: |
          cd minecraft-log-stream
          nohup node server.js > /dev/null 2>&1 &
          echo "Node server å·²å•Ÿå‹•æ–¼èƒŒæ™¯"

              # å¥åº·æª¢æŸ¥å¾ªç’°ï¼šç­‰å€™ API å›æ‡‰æˆåŠŸç‚ºæ­¢
          for i in {1..30}; do
            if curl --silent --fail http://localhost:3000/health >/dev/null; then
              echo "API is up!"
              break
            else
              echo "Waiting for API..."
              sleep 1
            fi
          done

      - name: é¡¯ç¤ºç•¶å‰ç›®éŒ„èˆ‡æª”æ¡ˆ
        run: |
          echo "ç›®å‰ç›®éŒ„ï¼š"
          pwd
          echo "æª”æ¡ˆåˆ—è¡¨ï¼š"
          ls -al

      - name: Minecraft Server é‹è¡Œä¸­ï¼ˆæœ€å¤š 5 å°æ™‚æˆ–æ‰‹å‹•é—œé–‰ï¼‰
        run: |
          echo "ä¼ºæœå™¨å•Ÿå‹•æˆåŠŸï¼Œæœ€å¤šé‹è¡Œ 5 å°æ™‚ã€‚"
          start_time=$(date +%s)
          timeout=$((5 * 60 * 60)) # 5 å°æ™‚
          while screen -list | grep -q "minecraft"; do
            now=$(date +%s)
            elapsed=$((now - start_time))
            if [ $elapsed -ge $timeout ]; then
              echo "å·²é” 5 å°æ™‚ï¼Œæº–å‚™è‡ªå‹•é—œé–‰ä¼ºæœå™¨..."
              break
            fi
            sleep 10
          done
          echo "ä¼ºæœå™¨å·²é—œé–‰æˆ–åˆ°æ™‚ï¼Œç¹¼çºŒä¸‹ä¸€æ­¥..."

      - name: å„ªé›…é—œé–‰ Minecraft ä¼ºæœå™¨ï¼ˆå¦‚æœé‚„æ´»è‘—ï¼‰
        run: |
          if screen -list | grep -q "minecraft"; then
            echo "ä¼ºæœå™¨ä»åœ¨é‹è¡Œï¼ŒåŸ·è¡Œ stop æŒ‡ä»¤..."
            screen -S minecraft -p 0 -X stuff "save-all flush$(printf \\r)"
            screen -S minecraft -p 0 -X stuff "stop$(printf \\r)"
            sleep 15
          else
            echo "ä¼ºæœå™¨å·²é—œé–‰ï¼Œç„¡éœ€å†æ¬¡ stopã€‚"
          fi

      - name: å£“ç¸®ä¸¦åˆ†å‰²æª”æ¡ˆ (æ¯ 2GB ä¸€å€‹åˆ†å·)
        run: |
          echo "æ­£åœ¨å£“ç¸®ä¸¦åˆ†å‰²ä¸–ç•Œæª”æ¡ˆ..."
          # ç¢ºä¿èˆŠæª”æ¸…ç†ä¹¾æ·¨
          rm -f world.zip world.z*
          # å°‡è³‡æ–™å¤¾å£“ç¸®æˆæ¯ä»½ 2GB çš„åˆ†å·
          zip -r -s 2g world.zip ./world

      - name: ä¸Šå‚³ world.zip åˆ° Google Drive
        run: |
          echo "æ­£åœ¨ä½¿ç”¨ç¬¬äºŒå€‹å¸³è™Ÿçš„å°ˆå±¬é€šé“ä¸Šå‚³..."
          
          # æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ gdrive2: æ˜¯å› ç‚ºæ‚¨åœ¨ PowerShell è¨­å®šæ™‚å–çš„åç¨±
          # ç›®æ¨™è·¯å¾‘æœƒç›´æ¥åœ¨ç¬¬äºŒå€‹å¸³è™Ÿå»ºç«‹ CobblemonWorld è³‡æ–™å¤¾
          rclone -vv copy ./ gdrive2:CobblemonWorld/ \
            --include "world.z*" \
            --include "world.zip" \
            --drive-chunk-size 128M \
            --tpslimit 1 \
            --drive-pacer-min-sleep 500ms \
            --drive-pacer-burst 1 \
            --transfers 1 \
            --retries 15 \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36" \
            --stats 10s

      # æœ€å¾Œä¸€å€‹ step è§¸ç™¼è‡ªå·±é‡æ–°åŸ·è¡Œ
      - name: è§¸ç™¼ä¸‹ä¸€æ¬¡åŸ·è¡Œ
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}       # âœ… å…§å»º tokenï¼Œæœ‰è§¸ç™¼æœ¬ repo çš„æ¬Šé™
          repository: ${{ github.repository }}      # âœ… è‡ªå·±çš„ repo
          event-type: fabric-server-cloud-backup-zerotier-vpn
